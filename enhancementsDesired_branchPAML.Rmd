---
title: "enhancementsDesired_branchPAML"
author: "Janet Young"
date: "`r Sys.Date()`"
output: html_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(janitor)
library(patchwork)
library(kableExtra)
library(ggtree)
library(treeio)
source("parseAndPlotPAML_functions.R")
```

# read data and make basic branch PAML plot

```{r}
ACE2_branchPAML_mlcFile <- "data/paml_version_4.10.6/example_ACE2/BRANCHpaml_initOmega0.4_codonModel2/mlc"

ACE2_branchPAML_results <- parseMLCbranches(ACE2_branchPAML_mlcFile)
```

Use the output of `parseMLCbranches()` to plot the tree, showing N, S, and dN/dS along each branch:

```{r, fig.height=9, fig.width=9}
plotTree(phymlTree=ACE2_branchPAML_results[["tree"]], 
         mlcTable=ACE2_branchPAML_results[["table"]], 
         labelType="omega_NS",
         myTitle="ACE2 branch PAML", 
         colorHighOmega=TRUE, 
         colorHighOmegaThreshold=1.2,
         highOmegaColor="red")
```

# enhancements I want

Now I use the `treeio::read.codeml_mlc` function to read the mlc file

```{r}
omega_threshold <- 1
NdN_threshold <- 0

colorScheme <- character()
colorScheme["interesting"] <- "red"
colorScheme["not_interesting"] <- "black"

## treedata object
ACE2_branchPAML_results_treeio <- read.codeml_mlc(ACE2_branchPAML_mlcFile) %>% 
    mutate(newLabel=case_when(
        is.na(dN_vs_dS) ~ "",
        TRUE ~ paste(round(dN_vs_dS, digits=2), "\n(", 
                     N_x_dN, ",", S_x_dS, ")", sep=""))) %>% 
    mutate(labelCategory= case_when(
        dN_vs_dS > omega_threshold & N_x_dN >= NdN_threshold ~ "interesting",
        TRUE ~ "not_interesting"
    )  ) %>% 
    ## add labelAgain because the tip labels get lost when I reroot, and this helps me keep them
    mutate(labelAgain=label)

## remove branch lengths
ACE2_branchPAML_results_treeio@phylo$edge.length <- NULL
```

And plot - this looks good!

```{r, fig.height=9, fig.width=9}
p1 <- ggtree(ACE2_branchPAML_results_treeio) +
    geom_tiplab(size=4) +
    geom_nodelab(aes(label=newLabel,color=labelCategory),
                 node="all",
                 size=3,
                 hjust=0.5, 
                 nudge_x=-0.5) +
    hexpand(0.5) +
    scale_color_manual(values=colorScheme) + 
    guides(color="none") +
    labs(title="ACE2 branch PAML plotted with ggtree")
p1
```


## try re-rooting

I CAN reroot the treedata object - seems to work fine. 

For the homing endonuclease project, rerooting the treedata object was a bad idea, and I had to reroot the phylo object and re-associate the data to the tree. But it seems to work for this case - I think the branch labels stay where they should. Perhaps my problem for the other project was that I was looking at NODE labels rather than BRANCH labels.


```{r, fig.height=9, fig.width=15}
ACE2_branchPAML_results_treeio_v2 <- parseMLCbranches_new(ACE2_branchPAML_mlcFile)

ACE2_branchPAML_results_treeio_v2_reroot <- root(
    ACE2_branchPAML_results_treeio_v2,
    node=getMRCA(ACE2_branchPAML_results_treeio_v2@phylo,
                 c("human_ACE2_ORF",
                   "white-tufted-ear_marmoset_ACE2")))

p1 <- plotTree_new(ACE2_branchPAML_results_treeio_v2, 
                   myTitle="ACE2 branch PAML, ggtree-based plot function")
p2 <- plotTree_new(ACE2_branchPAML_results_treeio_v2_reroot, 
                   myTitle="ACE2 branch PAML, rerooted, ggtree-based plot function")

p1 + p2
```



# Finished

show R version used, and package versions

```{r sessionInfo}
sessionInfo()
```
